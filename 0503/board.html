<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>114å­¸å¹´åº¦è¼”å°å®¤æš‘å‡ç‡ŸéšŠåå–®</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
  <style>
    body {
      background: #f5f8fb;
    }

    th, td {
      text-align: center;
      vertical-align: middle;
    }

    .highlight {
      background-color: #28a745;
      color: white;
      font-weight: bold;
    }

    .total-fee {
      font-weight: bold;
      color: #007bff;
    }

    table thead th {
      background-color: #cce5ff !important;
    }

    table tr:hover {
      background-color: #f1f9ff;
    }

    .table-container {
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
      border-radius: 8px;
      overflow: hidden;
    }
  </style>
</head>
<body>

<div class="container py-5">
  <h2 class="text-center text-primary mb-4">114å­¸å¹´åº¦è¼”å°å®¤æš‘å‡ç‡ŸéšŠåå–®</h2>

  <div class="d-flex flex-column flex-md-row justify-content-between gap-2 mb-3">
    <input type="text" id="searchInput" class="form-control me-2" placeholder="è¼¸å…¥é—œéµå­—æŸ¥è©¢ï¼ˆä¾‹å¦‚å§“åã€ç­ç´šï¼‰">
    <button id="downloadBtn" class="btn btn-success">ğŸ“¥ä¸‹è¼‰ Excel</button>
  </div>

  <div class="table-responsive table-container">
    <table class="table table-bordered table-hover table-striped bg-white" id="dataTable">
      <thead id="tableHead">
        <tr><td colspan="11">è¼‰å…¥ä¸­...</td></tr>
      </thead>
      <tbody id="tableBody">
        <tr><td colspan="11">è³‡æ–™è¼‰å…¥ä¸­...</td></tr>
      </tbody>
    </table>
  </div>
</div>

<script>
  const sheetdbURL = 'https://sheetdb.io/api/v1/pi0aipqod90md?sheet=å·¥ä½œè¡¨2';
  let allData = [];
  let activityColumns = [];

  fetch(sheetdbURL)
    .then(res => res.json())
    .then(data => {
      allData = data;
      detectActivityColumns(data[0]);
      updateMissingFees(data);
      renderTable(data);
    })
    .catch(err => {
      document.getElementById("tableBody").innerHTML = `<tr><td colspan='11'>è³‡æ–™è®€å–å¤±æ•—</td></tr>`;
      console.error("è¼‰å…¥å¤±æ•—ï¼š", err);
    });

  function detectActivityColumns(row) {
    activityColumns = [];
    Object.keys(row).forEach(key => {
      const match = key.match(/(.+)\s(\d+)$/);
      if (match) {
        activityColumns.push({ key, fee: parseInt(match[2]) });
      }
    });
  }

  function calculateTotal(row) {
    return activityColumns.reduce((sum, act) => {
      const joined = row[act.key];
      if (joined && joined.trim() !== "") {
        return sum + act.fee;
      }
      return sum;
    }, 0);
  }

  function updateMissingFees(data) {
    data.forEach(row => {
      const total = calculateTotal(row);
      if (!row.æ”¶è²» || parseInt(row.æ”¶è²») !== total) {
        fetch(`https://sheetdb.io/api/v1/pi0aipqod90md/ç·¨è™Ÿ/${row.ç·¨è™Ÿ}?sheet=å·¥ä½œè¡¨2`, {
          method: "PATCH",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ data: { æ”¶è²»: total } })
        }).then(res => res.json())
          .then(result => console.log(`âœ… å·²æ›´æ–° ç·¨è™Ÿ ${row.ç·¨è™Ÿ} æ”¶è²»ç‚º ${total}`))
          .catch(err => console.error(`âŒ ç·¨è™Ÿ ${row.ç·¨è™Ÿ} æ›´æ–°å¤±æ•—`, err));
      }
    });
  }

  function renderTable(data) {
    const thead = document.getElementById("tableHead");
    const tbody = document.getElementById("tableBody");
    tbody.innerHTML = "";

    if (!data.length) {
      tbody.innerHTML = "<tr><td colspan='11'>æŸ¥ç„¡è³‡æ–™</td></tr>";
      return;
    }

    const allKeys = Object.keys(data[0]);
    const headRow = document.createElement("tr");
    allKeys.forEach(k => {
      const th = document.createElement("th");
      th.textContent = k;
      headRow.appendChild(th);
    });
    thead.innerHTML = "";
    thead.appendChild(headRow);

    data.forEach(row => {
      const total = calculateTotal(row);
      const tr = document.createElement("tr");
      allKeys.forEach(k => {
        const td = document.createElement("td");
        let value = row[k] || "";

        // ç¾åŒ–æ´»å‹•é¸å–æ¬„ä½
        if (activityColumns.some(col => col.key === k) && value.trim() !== "") {
          td.classList.add("highlight");
        }

        // ç¾åŒ–æ”¶è²»æ¬„
        if (k === "æ”¶è²»") {
          td.classList.add("total-fee");
          value = total;
        }

        td.textContent = value;
        tr.appendChild(td);
      });
      tbody.appendChild(tr);
    });
  }

  document.getElementById('searchInput').addEventListener('input', function () {
    const keyword = this.value.trim().toLowerCase();
    const filtered = allData.filter(row =>
      Object.values(row).some(
        val => val && val.toLowerCase().includes(keyword)
      )
    );
    renderTable(filtered);
  });

  document.getElementById('downloadBtn').addEventListener('click', () => {
    const keyword = document.getElementById('searchInput').value.trim().toLowerCase();
    const filtered = allData.filter(row =>
      Object.values(row).some(
        val => val && val.toLowerCase().includes(keyword)
      )
    ).map(row => {
      return {
        ...row,
        æ”¶è²»: calculateTotal(row)
      };
    });

    const worksheet = XLSX.utils.json_to_sheet(filtered);
    const workbook = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(workbook, worksheet, "æš‘å‡ç‡ŸéšŠ");
    XLSX.writeFile(workbook, "114æš‘å‡ç‡ŸéšŠåå–®.xlsx");
  });
</script>

</body>
</html>
