<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>114å­¸å¹´åº¦è¼”å°å®¤æš‘å‡ç‡ŸéšŠåå–®</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body { background: #f5f8fb; }
    th, td { text-align: center; vertical-align: middle; word-break: break-word; }
    .highlight { background-color: #28a745; color: white; font-weight: bold; }
    .total-fee { font-weight: bold; color: #007bff; }
    .table-container { box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05); border-radius: 8px; overflow: hidden; }
    table thead th { background-color: #cce5ff !important; }
    table tr:hover { background-color: #f1f9ff; }
  </style>
</head>
<body>
<div class="modal fade" id="inputModal" tabindex="-1" aria-labelledby="inputModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title" id="inputModalLabel">æ–°å¢å ±åè³‡æ–™</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="é—œé–‰"></button>
      </div>
      <div class="modal-body">
        <form id="addForm">
          <div class="row g-3">
            <div class="col-md-4">
              <label class="form-label">ç­ç´š</label>
              <input type="text" id="newClass" class="form-control" required>
            </div>
            <div class="col-md-4">
              <label class="form-label">åº§è™Ÿ</label>
              <input type="text" id="newSeat" class="form-control" required>
            </div>
            <div class="col-md-4">
              <label class="form-label">å§“å</label>
              <input type="text" id="newName" class="form-control" required>
            </div>
            <div class="col-12 mt-3">
              <label class="form-label fw-bold">è«‹å‹¾é¸åƒåŠ æ´»å‹•ï¼š</label>
              <div id="activityCheckboxes" class="row g-2"></div>
            </div>
          </div>
          <div class="mt-3 text-end">
            <button type="submit" class="btn btn-success">âœ… å„²å­˜è³‡æ–™</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<div class="container py-5">
  <h2 class="text-center text-primary mb-4">114å­¸å¹´åº¦è¼”å°å®¤æš‘å‡ç‡ŸéšŠåå–®</h2>
  <div class="d-flex flex-column flex-md-row justify-content-between gap-2 mb-3">
    <input type="text" id="searchInput" class="form-control me-2" placeholder="è¼¸å…¥é—œéµå­—æŸ¥è©¢ï¼ˆä¾‹å¦‚å§“åã€ç­ç´šï¼‰">
    <div>
      <button class="btn btn-primary me-2" data-bs-toggle="modal" data-bs-target="#inputModal">â• æ–°å¢å ±å</button>
      <button id="pdfBtn" class="btn btn-danger">ğŸ“„ åŒ¯å‡º PDF</button>
    </div>
  </div>
  <div class="table-responsive table-container">
    <table class="table table-bordered table-hover table-striped bg-white" id="dataTable">
      <thead id="tableHead"><tr><td colspan="11">è¼‰å…¥ä¸­...</td></tr></thead>
      <tbody id="tableBody"><tr><td colspan="11">è³‡æ–™è¼‰å…¥ä¸­...</td></tr></tbody>
    </table>
  </div>
  <div id="summary" class="mt-4 bg-white rounded p-4 shadow-sm border border-primary">
    <h5 class="text-primary mb-3">ğŸ“Š çµ±è¨ˆæ‘˜è¦</h5>
    <div id="activitySummary" class="mb-2"></div>
    <div id="totalFeeSummary" class="fw-bold text-success"></div>
  </div>
</div>

<script>
const sheetdbURL = 'https://sheetdb.io/api/v1/pi0aipqod90md?sheet=ç‡ŸéšŠåå–®';
const activityLimits = { "çŸ³é¹¿ç™»å±±å£": 10 }; // å…¶ä»–é è¨­ç‚º 30 äºº
let allData = [];
let activityColumns = [];

fetch(sheetdbURL)
  .then(res => res.json())
  .then(data => {
    allData = data;
    detectActivityColumns(data[0]);
    renderActivityCheckboxes();
    renderTable(data);
    updateSummary(data);
  });

function detectActivityColumns(row) {
  activityColumns = [];
  Object.keys(row).forEach(key => {
    const match = key.match(/(.+)\s(\d+)$/);
    if (match) {
      activityColumns.push({ key, name: match[1], fee: parseInt(match[2]) });
    }
  });

  activityColumns.sort((a, b) => {
    const order = [
      "é™¶ç“·DIY 300", 
      "è‹‘è£¡é‡Œå±±å¡¾ 350", 
      "çŸ³é¹¿ç™»å±±å£ 500", 
      "æ¼‚æµ®èŠ±å‰ 150", 
      "ç¹ªç•«èª²ç¨‹ 150", 
      "åˆæ­¡å±± 0"
    ];
    return order.indexOf(a.key) - order.indexOf(b.key);
  });
}

function renderActivityCheckboxes() {
  const container = document.getElementById("activityCheckboxes");
  container.innerHTML = "";

  const joinCounts = {};
  activityColumns.forEach(col => joinCounts[col.key] = 0);
  allData.forEach(row => {
    activityColumns.forEach(col => {
      if (row[col.key] && row[col.key].trim() !== "") joinCounts[col.key]++;
    });
  });

  activityColumns.forEach(col => {
    const count = joinCounts[col.key];
    const limit = activityLimits[col.name] ?? 30;
    const remaining = limit - count;
    const disabled = remaining <= 0 ? 'disabled' : '';
    const labelText = remaining > 0
      ? `${col.name}ï¼ˆ${col.fee}å…ƒï½œå‰©é¤˜ ${remaining} åï¼‰`
      : `${col.name}ï¼ˆ${col.fee}å…ƒï½œâš  å·²é¡æ»¿ï¼‰`;

    const div = document.createElement("div");
    div.className = "col-md-6";
    div.innerHTML = `
      <div class="form-check">
        <input class="form-check-input" type="checkbox" id="activity-${col.key}" ${disabled}>
        <label class="form-check-label text-${remaining <= 0 ? 'danger fw-bold' : 'dark'}" for="activity-${col.key}">
          ${labelText}
        </label>
      </div>
    `;
    container.appendChild(div);
  });
}

function calculateTotal(row) {
  return activityColumns.reduce((sum, act) => {
    return (row[act.key] && row[act.key].trim() !== "") ? sum + act.fee : sum;
  }, 0);
}

function renderTable(data) {
  const thead = document.getElementById("tableHead");
  const tbody = document.getElementById("tableBody");
  tbody.innerHTML = "";

  const keys = Object.keys(data[0]);
  const headRow = document.createElement("tr");
  keys.forEach(k => {
    const th = document.createElement("th");
    th.textContent = k;
    headRow.appendChild(th);
  });
  thead.innerHTML = "";
  thead.appendChild(headRow);

  data.forEach(row => {
    const total = calculateTotal(row);
    const tr = document.createElement("tr");
    keys.forEach(k => {
      const td = document.createElement("td");
      let value = row[k] || "";
      if (k === "æ”¶è²»") {
        td.classList.add("total-fee");
        value = total;
      }
      td.textContent = value;
      tr.appendChild(td);
    });
    tbody.appendChild(tr);
  });
}

function updateSummary(data) {
  const summaryDiv = document.getElementById("activitySummary");
  const totalFeeDiv = document.getElementById("totalFeeSummary");

  const counts = {};
  let totalFee = 0;
  activityColumns.forEach(col => counts[col.name] = 0);
  data.forEach(row => {
    activityColumns.forEach(col => {
      if (row[col.key] && row[col.key].trim() !== "") counts[col.name]++;
    });
    totalFee += calculateTotal(row);
  });

  summaryDiv.innerHTML = Object.entries(counts).map(([activity, count]) => {
    const limit = activityLimits[activity] ?? 30;
    const remaining = limit - count;
    const percent = Math.min(Math.round((count / limit) * 100), 100);
    const over = count >= limit;

    return `
      <div class="mb-3">
        <strong>${activity}</strong>ï¼š${count} / ${limit} äººï½œå‰©é¤˜ 
        <span class="${over ? 'text-danger fw-bold' : 'text-success'}">
          ${remaining <= 0 ? '0ï¼ˆé¡æ»¿ï¼‰' : remaining + ' å'}
        </span>
        <div class="progress mt-1">
          <div class="progress-bar ${over ? 'bg-danger' : 'bg-success'}" role="progressbar" style="width: ${percent}%;" aria-valuenow="${percent}" aria-valuemin="0" aria-valuemax="100">
            ${percent}%
          </div>
        </div>
      </div>
    `;
  }).join("");

  totalFeeDiv.innerHTML = `ğŸ’° æ”¶è²»ç¸½é‡‘é¡ï¼š${totalFee} å…ƒ`;
}

document.getElementById("searchInput").addEventListener("input", function () {
  const keyword = this.value.trim().toLowerCase();
  const filtered = allData.filter(row =>
    Object.values(row).some(val => val && val.toLowerCase().includes(keyword))
  );
  renderTable(filtered);
  updateSummary(filtered);
});

document.getElementById("pdfBtn").addEventListener("click", async () => {
  const { jsPDF } = window.jspdf;
  const container = document.querySelector(".container");
  html2canvas(container, { scale: 2 }).then(canvas => {
    const imgData = canvas.toDataURL("image/png");
    const pdf = new jsPDF("p", "mm", "a4");
    const pageWidth = pdf.internal.pageSize.getWidth();
    const pageHeight = pdf.internal.pageSize.getHeight();
    const imgHeight = (canvas.height * pageWidth) / canvas.width;
    let heightLeft = imgHeight, position = 0;
    while (heightLeft > 0) {
      pdf.addImage(imgData, "PNG", 0, position, pageWidth, imgHeight);
      heightLeft -= pageHeight;
      if (heightLeft > 0) pdf.addPage();
    }
    pdf.save("114æš‘å‡ç‡ŸéšŠåå–®.pdf");
  });
});

document.getElementById("addForm").addEventListener("submit", function (e) {
  e.preventDefault();
  const ç­ç´š = document.getElementById("newClass").value.trim();
  const åº§è™Ÿ = document.getElementById("newSeat").value.trim();
  const å§“å = document.getElementById("newName").value.trim();
  if (!ç­ç´š || !åº§è™Ÿ || !å§“å) {
    alert("è«‹å¡«å¯«å®Œæ•´è³‡æ–™ï¼");
    return;
  }

  const formData = { ç­ç´š, åº§è™Ÿ, å§“å };
  activityColumns.forEach(col => {
    const checkbox = document.getElementById(`activity-${col.key}`);
    formData[col.key] = checkbox && checkbox.checked ? "âœ“" : "";
  });

  const newData = { data: formData };

  fetch(sheetdbURL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(newData)
  })
    .then(() => {
      alert("âœ… å·²æ–°å¢å ±åè³‡æ–™ï¼");
      bootstrap.Modal.getOrCreateInstance(document.getElementById('inputModal')).hide();
      location.reload();
    })
    .catch(err => alert("âŒ æ–°å¢å¤±æ•—ï¼š" + err));
});
</script>
</body>
</html>
