<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>114å­¸å¹´åº¦è¼”å°å®¤æš‘å‡ç‡ŸéšŠåå–®</title>
  <!-- å¥—ä»¶ CDN -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />

  <style>
    body {
      background: #f5f8fb;
    }
    th, td {
      text-align: center;
      vertical-align: middle;
      word-break: break-word;
    }
    .highlight {
      background-color: #28a745;
      color: white;
      font-weight: bold;
    }
    .total-fee {
      font-weight: bold;
      color: #007bff;
    }
    table thead th {
      background-color: #cce5ff !important;
    }
    table tr:hover {
      background-color: #f1f9ff;
    }
    .table-container {
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
      border-radius: 8px;
      overflow: hidden;
    }
  </style>
</head>
<body>

<div class="container py-5">
  <h2 class="text-center text-primary mb-4">114å­¸å¹´åº¦è¼”å°å®¤æš‘å‡ç‡ŸéšŠåå–®</h2>

  <div class="d-flex flex-column flex-md-row justify-content-between gap-2 mb-3">
    <input type="text" id="searchInput" class="form-control me-2" placeholder="è¼¸å…¥é—œéµå­—æŸ¥è©¢ï¼ˆä¾‹å¦‚å§“åã€ç­ç´šï¼‰">
    <button id="pdfBtn" class="btn btn-danger">ğŸ“„ åŒ¯å‡º PDF</button>
  </div>

  <div class="table-responsive table-container">
    <table class="table table-bordered table-hover table-striped bg-white" id="dataTable">
      <thead id="tableHead">
        <tr><td colspan="11">è¼‰å…¥ä¸­...</td></tr>
      </thead>
      <tbody id="tableBody">
        <tr><td colspan="11">è³‡æ–™è¼‰å…¥ä¸­...</td></tr>
      </tbody>
    </table>
  </div>

  <div id="summary" class="mt-4 bg-white rounded p-4 shadow-sm border border-primary">
    <h5 class="text-primary mb-3">ğŸ“Š çµ±è¨ˆæ‘˜è¦</h5>
    <div id="activitySummary" class="mb-2"></div>
    <div id="totalFeeSummary" class="fw-bold text-success"></div>
  </div>
</div>

<script>
  const sheetdbURL = 'https://sheetdb.io/api/v1/pi0aipqod90md?sheet=å·¥ä½œè¡¨2';
  let allData = [];
  let activityColumns = [];

  fetch(sheetdbURL)
    .then(res => res.json())
    .then(data => {
      allData = data;
      detectActivityColumns(data[0]);
      updateMissingFees(data);
      renderTable(data);
      updateSummary(data);
    })
    .catch(err => {
      document.getElementById("tableBody").innerHTML = `<tr><td colspan='11'>è³‡æ–™è®€å–å¤±æ•—</td></tr>`;
      console.error("è¼‰å…¥å¤±æ•—ï¼š", err);
    });

  function detectActivityColumns(row) {
    activityColumns = [];
    Object.keys(row).forEach(key => {
      const match = key.match(/(.+)\s(\d+)$/);
      if (match) {
        activityColumns.push({ key, name: match[1], fee: parseInt(match[2]) });
      }
    });
  }

  function calculateTotal(row) {
    return activityColumns.reduce((sum, act) => {
      const joined = row[act.key];
      if (joined && joined.trim() !== "") {
        return sum + act.fee;
      }
      return sum;
    }, 0);
  }

  function updateMissingFees(data) {
    data.forEach(row => {
      const total = calculateTotal(row);
      if (!row.æ”¶è²» || parseInt(row.æ”¶è²») !== total) {
        fetch(`https://sheetdb.io/api/v1/pi0aipqod90md/ç·¨è™Ÿ/${row.ç·¨è™Ÿ}?sheet=å·¥ä½œè¡¨2`, {
          method: "PATCH",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ data: { æ”¶è²»: total } })
        }).then(res => res.json())
          .then(result => console.log(`âœ… å·²æ›´æ–° ç·¨è™Ÿ ${row.ç·¨è™Ÿ} æ”¶è²»ç‚º ${total}`))
          .catch(err => console.error(`âŒ ç·¨è™Ÿ ${row.ç·¨è™Ÿ} æ›´æ–°å¤±æ•—`, err));
      }
    });
  }

  function renderTable(data) {
    const thead = document.getElementById("tableHead");
    const tbody = document.getElementById("tableBody");
    tbody.innerHTML = "";

    if (!data.length) {
      tbody.innerHTML = "<tr><td colspan='11'>æŸ¥ç„¡è³‡æ–™</td></tr>";
      return;
    }

    const allKeys = Object.keys(data[0]);
    const headRow = document.createElement("tr");
    allKeys.forEach(k => {
      const th = document.createElement("th");
      th.textContent = k;
      headRow.appendChild(th);
    });
    thead.innerHTML = "";
    thead.appendChild(headRow);

    data.forEach(row => {
      const total = calculateTotal(row);
      const tr = document.createElement("tr");
      allKeys.forEach(k => {
        const td = document.createElement("td");
        let value = row[k] || "";

        if (activityColumns.some(col => col.key === k) && value.trim() !== "") {
          td.classList.add("highlight");
        }

        if (k === "æ”¶è²»") {
          td.classList.add("total-fee");
          value = total;
        }

        td.textContent = value;
        tr.appendChild(td);
      });
      tbody.appendChild(tr);
    });
  }

  function updateSummary(data) {
    const summaryDiv = document.getElementById("activitySummary");
    const totalFeeDiv = document.getElementById("totalFeeSummary");

    const counts = {};
    let totalFee = 0;

    // è¨­å®šäººæ•¸ä¸Šé™ï¼ˆå¯ä¾éœ€æ±‚æ–°å¢ï¼‰
    const limits = {
      "çŸ³é¹¿ç™»å±±å£é€²": 10
      // å…¶ä»–æ²’æŒ‡å®šçš„é è¨­ç‚º 30
    };

    activityColumns.forEach(col => counts[col.name] = 0);

    data.forEach(row => {
      activityColumns.forEach(col => {
        if (row[col.key] && row[col.key].trim() !== "") {
          counts[col.name]++;
        }
      });
      totalFee += calculateTotal(row);
    });

    summaryDiv.innerHTML = Object.entries(counts)
      .map(([activity, count]) => {
        const limit = limits[activity] ?? 30;
        const isOver = count > limit;
        return `${isOver ? 'â—' : 'âœ…'} <strong>${activity}</strong>ï¼š${count} äººï¼ˆä¸Šé™ ${limit}ï¼‰` +
               (isOver ? ` <span class="text-danger fw-bold">âš  å·²è¶…é</span>` : '');
      })
      .join("<br>");

    totalFeeDiv.textContent = `ğŸ’° æ”¶è²»ç¸½é‡‘é¡ï¼š${totalFee} å…ƒ`;
  }

  document.getElementById('searchInput').addEventListener('input', function () {
    const keyword = this.value.trim().toLowerCase();
    const filtered = allData.filter(row =>
      Object.values(row).some(
        val => val && val.toLowerCase().includes(keyword)
      )
    );
    renderTable(filtered);
    updateSummary(filtered);
  });

  // åŒ¯å‡º PDFï¼ˆè‡ªå‹•åˆ†é ï¼‰
  document.getElementById('pdfBtn').addEventListener('click', async () => {
    const { jsPDF } = window.jspdf;
    const container = document.querySelector('.container');

    html2canvas(container, { scale: 2 }).then(canvas => {
      const imgData = canvas.toDataURL('image/png');
      const pdf = new jsPDF('p', 'mm', 'a4');
      const pageWidth = pdf.internal.pageSize.getWidth();
      const pageHeight = pdf.internal.pageSize.getHeight();

      const imgWidth = pageWidth;
      const imgHeight = (canvas.height * imgWidth) / canvas.width;

      let heightLeft = imgHeight;
      let position = 0;

      while (heightLeft > 0) {
        pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
        heightLeft -= pageHeight;
        if (heightLeft > 0) {
          pdf.addPage();
        }
      }

      pdf.save("114æš‘å‡ç‡ŸéšŠåå–®.pdf");
    });
  });
</script>

</body>
</html>
